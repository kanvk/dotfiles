# Prefix
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# Reload
unbind r
bind r source-file ~/.tmux.conf \; display-message "Config reloaded"

set -g mouse on  # Enable mouse

# Terminal / color support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Focus events (needed for nvim autoread/FocusGained)
set -g focus-events on

# Scrollback
set -g history-limit 50000

# OSC 52 clipboard (works over SSH)
set -g set-clipboard on
set -g allow-passthrough on

# Faster escape (important for neovim)
set -sg escape-time 10

# Window/pane numbering starts at 1
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# vim mode
setw -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Copy mode vi bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Splits and windows preserve working directory
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Pane resize with vim keys (repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Session management
bind-key f run-shell "sesh connect \"$(sesh list | fzf-tmux -p 55%,60% --no-sort --ansi --border-label ' sesh ' --prompt '⚡ ')\""
bind-key Tab switch-client -l  # Toggle last session
bind-key X confirm-before -p "Kill session #S? (y/n)" kill-session

# Window management
bind-key -r > swap-window -d -t +1  # Move window right
bind-key -r < swap-window -d -t -1  # Move window left

# Pane management
bind-key x kill-pane              # Kill pane without confirm (default asks)
bind-key z resize-pane -Z         # Toggle pane zoom (default, here for clarity)
bind-key m set-option -g mouse \; display-message "Mouse #{?mouse,ON,OFF}"

# Search scrollback
bind-key / copy-mode -e \; send-keys ?  # Enter copy-mode and search up (vim-style)

# Scroll UX (native scrollbars + better copy-mode + mighty-scroll)

# Native pane scrollbars (tmux 3.6+)
set -g pane-scrollbars modal
set -g pane-scrollbars-position right

# Mouse wheel: reliably enter copy-mode when scrolling up in tmux history
# (If an app like nvim captures the mouse, it may still handle scrolling itself.)
bind -n WheelUpPane   if -F "#{pane_in_mode}" "send -M" "copy-mode -e; send -M"
bind -n WheelDownPane if -F "#{pane_in_mode}" "send -M" "send -M"

# Obvious indicator when you’re scrolled back / in copy-mode
set -g pane-border-status top
set -g pane-border-format "#{?pane_in_mode,#[reverse] COPY #[default],} #P #{pane_current_command}"

# Vim-like copy-mode scrolling ergonomics
setw -g mode-keys vi
bind -T copy-mode-vi C-u send -X halfpage-up
bind -T copy-mode-vi C-d send -X halfpage-down
bind -T copy-mode-vi g   send -X history-top
bind -T copy-mode-vi G   send -X history-bottom

# tmux-mighty-scroll (plugin: noscript/tmux-mighty-scroll)
set -g @mighty-scroll-enabled 'on'
set -g @mighty-scroll-smooth 'on'
set -g @mighty-scroll-speed '1'
set -g @mighty-scroll-interval '2'

# Treat these as line-by-line scrollers (helps avoid huge jumps)
set -g @mighty-scroll-by-line 'less,man,more,most,moar.fzf,nvim,vi,vim'

# If process detection fails (common over SSH), fall back to tmux copy-mode behavior
set -g @mighty-scroll-fallback-mode 'copy-mode'

# Plugins
set -g @plugin 'tmux-plugins/tpm'  # git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'dracula/tmux'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'noscript/tmux-mighty-scroll'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'schasse/tmux-jump'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'fcsonline/tmux-thumbs'

# Dracula config
set -g @dracula-plugins "time ssh-session attached-clients"
set -g @dracula-show-powerline true
set -g @dracula-show-edge-icons true
set -g @dracula-show-flags true
set -g @dracula-show-left-icon session
set -g status-position bottom
set -g @dracula-time-format "%m/%d %I:%M %p %Z"
set -g @dracula-clients-singular cl
set -g @dracula-clients-plural cl

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Continuum
set -g @continuum-restore 'on'
set -g @continuum-save-interval '10'

# Initialize TMUX plugin manager
run '~/.tmux/plugins/tpm/tpm'
